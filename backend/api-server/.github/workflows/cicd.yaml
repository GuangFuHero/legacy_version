name: Deploy to GCP
permissions:
  contents: read

on:
  workflow_call:
    inputs:
      branches:
        description: Branches to allow deployment from
        required: false
        type: string
        default: "develop,main"
      service_path:
        description: Backend service path
        required: false
        type: string
        default: backend/api-server
    secrets:
      VM_HOST:
        required: true
      DEPLOY_SSH_KEY:
        required: true
      POSTGRES_PASSWORD:
        required: true
      ALLOW_MODIFY_API_KEY_LIST:
        required: false
      LINE_CLIENT_ID:
        required: false
      LINE_CLIENT_SECRET:
        required: false
      DISCORD_WEBHOOK_URL:
        required: false

jobs:
  init:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set_env.outputs.environment }}
      version: ${{ steps.set_env.outputs.version }}
      should_deploy: ${{ steps.set_env.outputs.should_deploy }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine environment and version
        id: set_env
        shell: bash
        run: |
          REF="${{ github.ref }}"
          echo "Current ref: ${REF}"

          if [[ "${REF}" == "refs/heads/develop" ]]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "version=develop" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${REF}" == "refs/heads/main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "version=latest" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${REF}" == refs/tags/* ]]; then
            git fetch origin main --depth=1
            TAG_COMMIT=$(git rev-parse HEAD)
            if ! git merge-base --is-ancestor "$TAG_COMMIT" origin/main; then
              echo "Error: Tag must be created from main branch"
              echo "should_deploy=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            VERSION=${REF#refs/tags/}
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: init
    if: needs.init.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    environment: ${{ needs.init.outputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to GCP VM via SSH
        uses: appleboy/ssh-action@v1.2.2
        env:
          ENVIRONMENT: ${{ needs.init.outputs.environment }}
          DB_PASS: ${{ secrets.POSTGRES_PASSWORD }}
          API_KEY_LIST: ${{ secrets.ALLOW_MODIFY_API_KEY_LIST }}
          LINE_CLIENT_ID: ${{ secrets.LINE_CLIENT_ID }}
          LINE_CLIENT_SECRET: ${{ secrets.LINE_CLIENT_SECRET }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          host: ${{ secrets.VM_HOST }}
          username: deploy
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          envs: ENVIRONMENT,DB_PASS,API_KEY_LIST,LINE_CLIENT_ID,LINE_CLIENT_SECRET,DISCORD_WEBHOOK_URL
          script: |
            cd /home/deploy/api-server
            ./deploy.sh ${{ needs.init.outputs.version }}

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.VM_HOST }}
          username: deploy
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          script: |
            cd /home/deploy/api-server/guanfu_backend
            docker compose ps
            curl -f http://localhost:8000/docs || echo "Warning: Backend health check failed"
